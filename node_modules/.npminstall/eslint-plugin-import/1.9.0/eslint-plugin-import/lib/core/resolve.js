'use strict';

exports.__esModule = true;
exports.CASE_SENSITIVE_FS = undefined;

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

exports.relative = relative;
exports.default = resolve;

require('es6-symbol/implement');

var _es6Map = require('es6-map');

var _es6Map2 = _interopRequireDefault(_es6Map);

var _es6Set = require('es6-set');

var _es6Set2 = _interopRequireDefault(_es6Set);

var _objectAssign = require('object-assign');

var _objectAssign2 = _interopRequireDefault(_objectAssign);

var _pkgDir = require('pkg-dir');

var _pkgDir2 = _interopRequireDefault(_pkgDir);

var _isAbsolute = require('is-absolute');

var _isAbsolute2 = _interopRequireDefault(_isAbsolute);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _crypto = require('crypto');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var isAbsolute = _path.isAbsolute || _isAbsolute2.default;

var CASE_SENSITIVE_FS = exports.CASE_SENSITIVE_FS = !_fs2.default.existsSync((0, _path.join)(__dirname, 'reSOLVE.js'));

var fileExistsCache = new _es6Map2.default();

function cachePath(cacheKey, result) {
  fileExistsCache.set(cacheKey, { result: result, lastSeen: Date.now() });
}

function checkCache(cacheKey, _ref) {
  var lifetime = _ref.lifetime;

  if (fileExistsCache.has(cacheKey)) {
    var _fileExistsCache$get = fileExistsCache.get(cacheKey);

    var result = _fileExistsCache$get.result;
    var lastSeen = _fileExistsCache$get.lastSeen;
    // check fresness

    if (Date.now() - lastSeen < lifetime * 1000) return result;
  }
  // cache miss
  return undefined;
}

// http://stackoverflow.com/a/27382838
function fileExistsWithCaseSync(filepath, cacheSettings) {
  // don't care if the FS is case-sensitive
  if (CASE_SENSITIVE_FS) return true;

  // null means it resolved to a builtin
  if (filepath === null) return true;

  var dir = (0, _path.dirname)(filepath);

  var result = checkCache(filepath, cacheSettings);
  if (result != null) return result;

  // base case
  if (dir === '/' || dir === '.' || /^[A-Z]:\\$/i.test(dir)) {
    result = true;
  } else {
    var filenames = _fs2.default.readdirSync(dir);
    if (filenames.indexOf((0, _path.basename)(filepath)) === -1) {
      result = false;
    } else {
      result = fileExistsWithCaseSync(dir, cacheSettings);
    }
  }
  cachePath(filepath, result);
  return result;
}

function relative(modulePath, sourceFile, settings) {

  var sourceDir = (0, _path.dirname)(sourceFile),
      cacheKey = sourceDir + hashObject(settings) + modulePath;

  var cacheSettings = (0, _objectAssign2.default)({
    lifetime: 30 }, // seconds
  settings['import/cache']);

  // parse infinity
  if (cacheSettings.lifetime === 'âˆž' || cacheSettings.lifetime === 'Infinity') {
    cacheSettings.lifetime = Infinity;
  }

  var cachedPath = checkCache(cacheKey, cacheSettings);
  if (cachedPath !== undefined) return cachedPath;

  function cache(path) {
    cachePath(cacheKey, path);
    return path;
  }

  function withResolver(resolver, config) {

    function v1() {
      try {
        var path = resolver.resolveImport(modulePath, sourceFile, config);
        if (path === undefined) return { found: false };
        return { found: true, path: path };
      } catch (err) {
        return { found: false };
      }
    }

    function v2() {
      return resolver.resolve(modulePath, sourceFile, config);
    }

    switch (resolver.interfaceVersion) {
      case 2:
        return v2();

      default:
      case 1:
        return v1();
    }
  }

  var configResolvers = settings['import/resolver'] || { 'node': settings['import/resolve'] }; // backward compatibility

  var resolvers = resolverReducer(configResolvers, new _es6Map2.default());

  for (var _iterator = resolvers, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
    var _ref2;

    if (_isArray) {
      if (_i >= _iterator.length) break;
      _ref2 = _iterator[_i++];
    } else {
      _i = _iterator.next();
      if (_i.done) break;
      _ref2 = _i.value;
    }

    var _ref3 = _ref2;
    var name = _ref3[0];
    var config = _ref3[1];

    var resolver = requireResolver(name, sourceFile);

    var _withResolver = withResolver(resolver, config);

    var fullPath = _withResolver.path;
    var found = _withResolver.found;

    // resolvers imply file existence, this double-check just ensures the case matches

    if (found && !fileExistsWithCaseSync(fullPath, cacheSettings)) {
      // reject resolved path
      fullPath = undefined;
    }

    if (found) return cache(fullPath);
  }

  return cache(undefined);
}

function resolverReducer(resolvers, map) {
  if (resolvers instanceof Array) {
    resolvers.forEach(function (r) {
      return resolverReducer(r, map);
    });
    return map;
  }

  if (typeof resolvers === 'string') {
    map.set(resolvers, null);
    return map;
  }

  if ((typeof resolvers === 'undefined' ? 'undefined' : _typeof(resolvers)) === 'object') {
    for (var key in resolvers) {
      map.set(key, resolvers[key]);
    }
    return map;
  }

  throw new Error('invalid resolver config');
}

function requireResolver(name, sourceFile) {
  // Try to resolve package with absolute path (/Volumes/....)
  if (isAbsolute(name)) {
    try {
      return require(name);
    } catch (err) {/* continue */}
  }

  // Try to resolve package with path, relative to closest package.json
  try {
    var packageDir = _pkgDir2.default.sync(sourceFile);
    return require((0, _path.join)(packageDir, name));
  } catch (err) {} /* continue */

  // Try to resolve package with custom name (@myorg/resolver-name)
  try {
    return require(name);
  } catch (err) {} /* continue */

  // Try to resolve package with conventional name
  try {
    return require('eslint-import-resolver-' + name);
  } catch (err) {} /* continue */

  // all else failed
  throw new Error('unable to load resolver "' + name + '".');
}

var erroredContexts = new _es6Set2.default();

/**
 * Given
 * @param  {string} p - module path
 * @param  {object} context - ESLint context
 * @return {string} - the full module filesystem path;
 *                    null if package is core;
 *                    undefined if not found
 */
function resolve(p, context) {
  try {
    return relative(p, context.getFilename(), context.settings);
  } catch (err) {
    if (!erroredContexts.has(context)) {
      context.report({
        message: 'Resolve error: ' + err.message,
        loc: { line: 1, col: 0 }
      });
      erroredContexts.add(context);
    }
  }
}
resolve.relative = relative;

function hashObject(object) {
  var settingsShasum = (0, _crypto.createHash)('sha1');
  settingsShasum.update(JSON.stringify(object));
  return settingsShasum.digest('hex');
}
//# sourceMappingURL=data:application/json;base64,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UCxDQUZFO0dBQUosQ0FHRSxPQUFPLEdBQVAsRUFBWTs7O0FBQVosTUFHRTtBQUNGLFdBQU8sUUFBUSxJQUFSLENBQVAsQ0FERTtHQUFKLENBRUUsT0FBTyxHQUFQLEVBQVk7OztBQUFaLE1BR0U7QUFDRixXQUFPLG9DQUFrQyxJQUFsQyxDQUFQLENBREU7R0FBSixDQUVFLE9BQU8sR0FBUCxFQUFZOzs7QUFBWixRQUdJLElBQUksS0FBSiwrQkFBc0MsV0FBdEMsQ0FBTixDQXpCeUM7Q0FBM0M7O0FBNEJBLElBQU0sa0JBQWtCLHNCQUFsQjs7Ozs7Ozs7OztBQVVTLFNBQVMsT0FBVCxDQUFpQixDQUFqQixFQUFvQixPQUFwQixFQUE2QjtBQUMxQyxNQUFJO0FBQ0YsV0FBTyxTQUFVLENBQVYsRUFDVSxRQUFRLFdBQVIsRUFEVixFQUVVLFFBQVEsUUFBUixDQUZqQixDQURFO0dBQUosQ0FLRSxPQUFPLEdBQVAsRUFBWTtBQUNaLFFBQUksQ0FBQyxnQkFBZ0IsR0FBaEIsQ0FBb0IsT0FBcEIsQ0FBRCxFQUErQjtBQUNqQyxjQUFRLE1BQVIsQ0FBZTtBQUNiLHFDQUEyQixJQUFJLE9BQUo7QUFDM0IsYUFBSyxFQUFFLE1BQU0sQ0FBTixFQUFTLEtBQUssQ0FBTCxFQUFoQjtPQUZGLEVBRGlDO0FBS2pDLHNCQUFnQixHQUFoQixDQUFvQixPQUFwQixFQUxpQztLQUFuQztHQURBO0NBTlc7QUFnQmYsUUFBUSxRQUFSLEdBQW1CLFFBQW5COztBQUlBLFNBQVMsVUFBVCxDQUFvQixNQUFwQixFQUE0QjtBQUMxQixNQUFNLGlCQUFpQix3QkFBVyxNQUFYLENBQWpCLENBRG9CO0FBRTFCLGlCQUFlLE1BQWYsQ0FBc0IsS0FBSyxTQUFMLENBQWUsTUFBZixDQUF0QixFQUYwQjtBQUcxQixTQUFPLGVBQWUsTUFBZixDQUFzQixLQUF0QixDQUFQLENBSDBCO0NBQTVCIiwiZmlsZSI6ImNvcmUvcmVzb2x2ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnZXM2LXN5bWJvbC9pbXBsZW1lbnQnXG5pbXBvcnQgTWFwIGZyb20gJ2VzNi1tYXAnXG5pbXBvcnQgU2V0IGZyb20gJ2VzNi1zZXQnXG5pbXBvcnQgYXNzaWduIGZyb20gJ29iamVjdC1hc3NpZ24nXG5pbXBvcnQgcGtnRGlyIGZyb20gJ3BrZy1kaXInXG5pbXBvcnQgaXNBYnNvbHV0ZUZhbGxiYWNrIGZyb20gJ2lzLWFic29sdXRlJ1xuXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBkaXJuYW1lLCBiYXNlbmFtZSwgam9pbiwgaXNBYnNvbHV0ZSBhcyBpc0Fic29sdXRlTm9kZSB9IGZyb20gJ3BhdGgnXG5cbmNvbnN0IGlzQWJzb2x1dGUgPSBpc0Fic29sdXRlTm9kZSB8fCBpc0Fic29sdXRlRmFsbGJhY2tcblxuZXhwb3J0IGNvbnN0IENBU0VfU0VOU0lUSVZFX0ZTID0gIWZzLmV4aXN0c1N5bmMoam9pbihfX2Rpcm5hbWUsICdyZVNPTFZFLmpzJykpXG5cbmNvbnN0IGZpbGVFeGlzdHNDYWNoZSA9IG5ldyBNYXAoKVxuXG5mdW5jdGlvbiBjYWNoZVBhdGgoY2FjaGVLZXksIHJlc3VsdCkge1xuICBmaWxlRXhpc3RzQ2FjaGUuc2V0KGNhY2hlS2V5LCB7IHJlc3VsdCwgbGFzdFNlZW46IERhdGUubm93KCkgfSlcbn1cblxuZnVuY3Rpb24gY2hlY2tDYWNoZShjYWNoZUtleSwgeyBsaWZldGltZSB9KSB7XG4gIGlmIChmaWxlRXhpc3RzQ2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgIGNvbnN0IHsgcmVzdWx0LCBsYXN0U2VlbiB9ID0gZmlsZUV4aXN0c0NhY2hlLmdldChjYWNoZUtleSlcbiAgICAvLyBjaGVjayBmcmVzbmVzc1xuICAgIGlmIChEYXRlLm5vdygpIC0gbGFzdFNlZW4gPCAobGlmZXRpbWUgKiAxMDAwKSkgcmV0dXJuIHJlc3VsdFxuICB9XG4gIC8vIGNhY2hlIG1pc3NcbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG4vLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yNzM4MjgzOFxuZnVuY3Rpb24gZmlsZUV4aXN0c1dpdGhDYXNlU3luYyhmaWxlcGF0aCwgY2FjaGVTZXR0aW5ncykge1xuICAvLyBkb24ndCBjYXJlIGlmIHRoZSBGUyBpcyBjYXNlLXNlbnNpdGl2ZVxuICBpZiAoQ0FTRV9TRU5TSVRJVkVfRlMpIHJldHVybiB0cnVlXG5cbiAgLy8gbnVsbCBtZWFucyBpdCByZXNvbHZlZCB0byBhIGJ1aWx0aW5cbiAgaWYgKGZpbGVwYXRoID09PSBudWxsKSByZXR1cm4gdHJ1ZVxuXG4gIGNvbnN0IGRpciA9IGRpcm5hbWUoZmlsZXBhdGgpXG5cbiAgbGV0IHJlc3VsdCA9IGNoZWNrQ2FjaGUoZmlsZXBhdGgsIGNhY2hlU2V0dGluZ3MpXG4gIGlmIChyZXN1bHQgIT0gbnVsbCkgcmV0dXJuIHJlc3VsdFxuXG4gIC8vIGJhc2UgY2FzZVxuICBpZiAoZGlyID09PSAnLycgfHwgZGlyID09PSAnLicgfHwgL15bQS1aXTpcXFxcJC9pLnRlc3QoZGlyKSkge1xuICAgIHJlc3VsdCA9IHRydWVcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBmaWxlbmFtZXMgPSBmcy5yZWFkZGlyU3luYyhkaXIpXG4gICAgaWYgKGZpbGVuYW1lcy5pbmRleE9mKGJhc2VuYW1lKGZpbGVwYXRoKSkgPT09IC0xKSB7XG4gICAgICByZXN1bHQgPSBmYWxzZVxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBmaWxlRXhpc3RzV2l0aENhc2VTeW5jKGRpciwgY2FjaGVTZXR0aW5ncylcbiAgICB9XG4gIH1cbiAgY2FjaGVQYXRoKGZpbGVwYXRoLCByZXN1bHQpXG4gIHJldHVybiByZXN1bHRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbGF0aXZlKG1vZHVsZVBhdGgsIHNvdXJjZUZpbGUsIHNldHRpbmdzKSB7XG5cbiAgY29uc3Qgc291cmNlRGlyID0gZGlybmFtZShzb3VyY2VGaWxlKVxuICAgICAgLCBjYWNoZUtleSA9IHNvdXJjZURpciArIGhhc2hPYmplY3Qoc2V0dGluZ3MpICsgbW9kdWxlUGF0aFxuXG4gIGNvbnN0IGNhY2hlU2V0dGluZ3MgPSBhc3NpZ24oe1xuICAgIGxpZmV0aW1lOiAzMCwgIC8vIHNlY29uZHNcbiAgfSwgc2V0dGluZ3NbJ2ltcG9ydC9jYWNoZSddKVxuXG4gIC8vIHBhcnNlIGluZmluaXR5XG4gIGlmIChjYWNoZVNldHRpbmdzLmxpZmV0aW1lID09PSAn4oieJyB8fCBjYWNoZVNldHRpbmdzLmxpZmV0aW1lID09PSAnSW5maW5pdHknKSB7XG4gICAgY2FjaGVTZXR0aW5ncy5saWZldGltZSA9IEluZmluaXR5XG4gIH1cblxuICBjb25zdCBjYWNoZWRQYXRoID0gY2hlY2tDYWNoZShjYWNoZUtleSwgY2FjaGVTZXR0aW5ncylcbiAgaWYgKGNhY2hlZFBhdGggIT09IHVuZGVmaW5lZCkgcmV0dXJuIGNhY2hlZFBhdGhcblxuICBmdW5jdGlvbiBjYWNoZShwYXRoKSB7XG4gICAgY2FjaGVQYXRoKGNhY2hlS2V5LCBwYXRoKVxuICAgIHJldHVybiBwYXRoXG4gIH1cblxuICBmdW5jdGlvbiB3aXRoUmVzb2x2ZXIocmVzb2x2ZXIsIGNvbmZpZykge1xuXG4gICAgZnVuY3Rpb24gdjEoKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYXRoID0gcmVzb2x2ZXIucmVzb2x2ZUltcG9ydChtb2R1bGVQYXRoLCBzb3VyY2VGaWxlLCBjb25maWcpXG4gICAgICAgIGlmIChwYXRoID09PSB1bmRlZmluZWQpIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9XG4gICAgICAgIHJldHVybiB7IGZvdW5kOiB0cnVlLCBwYXRoIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4geyBmb3VuZDogZmFsc2UgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHYyKCkge1xuICAgICAgcmV0dXJuIHJlc29sdmVyLnJlc29sdmUobW9kdWxlUGF0aCwgc291cmNlRmlsZSwgY29uZmlnKVxuICAgIH1cblxuICAgIHN3aXRjaCAocmVzb2x2ZXIuaW50ZXJmYWNlVmVyc2lvbikge1xuICAgICAgY2FzZSAyOlxuICAgICAgICByZXR1cm4gdjIoKVxuXG4gICAgICBkZWZhdWx0OlxuICAgICAgY2FzZSAxOlxuICAgICAgICByZXR1cm4gdjEoKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGNvbmZpZ1Jlc29sdmVycyA9IChzZXR0aW5nc1snaW1wb3J0L3Jlc29sdmVyJ11cbiAgICB8fCB7ICdub2RlJzogc2V0dGluZ3NbJ2ltcG9ydC9yZXNvbHZlJ10gfSkgLy8gYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuXG4gIGNvbnN0IHJlc29sdmVycyA9IHJlc29sdmVyUmVkdWNlcihjb25maWdSZXNvbHZlcnMsIG5ldyBNYXAoKSlcblxuICBmb3IgKGxldCBbbmFtZSwgY29uZmlnXSBvZiByZXNvbHZlcnMpIHtcbiAgICBjb25zdCByZXNvbHZlciA9IHJlcXVpcmVSZXNvbHZlcihuYW1lLCBzb3VyY2VGaWxlKVxuXG4gICAgbGV0IHsgcGF0aDogZnVsbFBhdGgsIGZvdW5kIH0gPSB3aXRoUmVzb2x2ZXIocmVzb2x2ZXIsIGNvbmZpZylcblxuICAgIC8vIHJlc29sdmVycyBpbXBseSBmaWxlIGV4aXN0ZW5jZSwgdGhpcyBkb3VibGUtY2hlY2sganVzdCBlbnN1cmVzIHRoZSBjYXNlIG1hdGNoZXNcbiAgICBpZiAoZm91bmQgJiYgIWZpbGVFeGlzdHNXaXRoQ2FzZVN5bmMoZnVsbFBhdGgsIGNhY2hlU2V0dGluZ3MpKSB7XG4gICAgICAvLyByZWplY3QgcmVzb2x2ZWQgcGF0aFxuICAgICAgZnVsbFBhdGggPSB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBpZiAoZm91bmQpIHJldHVybiBjYWNoZShmdWxsUGF0aClcbiAgfVxuXG4gIHJldHVybiBjYWNoZSh1bmRlZmluZWQpXG59XG5cbmZ1bmN0aW9uIHJlc29sdmVyUmVkdWNlcihyZXNvbHZlcnMsIG1hcCkge1xuICBpZiAocmVzb2x2ZXJzIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICByZXNvbHZlcnMuZm9yRWFjaChyID0+IHJlc29sdmVyUmVkdWNlcihyLCBtYXApKVxuICAgIHJldHVybiBtYXBcbiAgfVxuXG4gIGlmICh0eXBlb2YgcmVzb2x2ZXJzID09PSAnc3RyaW5nJykge1xuICAgIG1hcC5zZXQocmVzb2x2ZXJzLCBudWxsKVxuICAgIHJldHVybiBtYXBcbiAgfVxuXG4gIGlmICh0eXBlb2YgcmVzb2x2ZXJzID09PSAnb2JqZWN0Jykge1xuICAgIGZvciAobGV0IGtleSBpbiByZXNvbHZlcnMpIHtcbiAgICAgIG1hcC5zZXQoa2V5LCByZXNvbHZlcnNba2V5XSlcbiAgICB9XG4gICAgcmV0dXJuIG1hcFxuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHJlc29sdmVyIGNvbmZpZycpXG59XG5cbmZ1bmN0aW9uIHJlcXVpcmVSZXNvbHZlcihuYW1lLCBzb3VyY2VGaWxlKSB7XG4gIC8vIFRyeSB0byByZXNvbHZlIHBhY2thZ2Ugd2l0aCBhYnNvbHV0ZSBwYXRoICgvVm9sdW1lcy8uLi4uKVxuICBpZiAoaXNBYnNvbHV0ZShuYW1lKSkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gcmVxdWlyZShuYW1lKVxuICAgIH0gY2F0Y2ggKGVycikgeyAvKiBjb250aW51ZSAqLyB9XG4gIH1cblxuICAvLyBUcnkgdG8gcmVzb2x2ZSBwYWNrYWdlIHdpdGggcGF0aCwgcmVsYXRpdmUgdG8gY2xvc2VzdCBwYWNrYWdlLmpzb25cbiAgdHJ5IHtcbiAgICBjb25zdCBwYWNrYWdlRGlyID0gcGtnRGlyLnN5bmMoc291cmNlRmlsZSlcbiAgICByZXR1cm4gcmVxdWlyZShqb2luKHBhY2thZ2VEaXIsIG5hbWUpKVxuICB9IGNhdGNoIChlcnIpIHsgLyogY29udGludWUgKi8gfVxuXG4gIC8vIFRyeSB0byByZXNvbHZlIHBhY2thZ2Ugd2l0aCBjdXN0b20gbmFtZSAoQG15b3JnL3Jlc29sdmVyLW5hbWUpXG4gIHRyeSB7XG4gICAgcmV0dXJuIHJlcXVpcmUobmFtZSlcbiAgfSBjYXRjaCAoZXJyKSB7IC8qIGNvbnRpbnVlICovIH1cblxuICAvLyBUcnkgdG8gcmVzb2x2ZSBwYWNrYWdlIHdpdGggY29udmVudGlvbmFsIG5hbWVcbiAgdHJ5IHtcbiAgICByZXR1cm4gcmVxdWlyZShgZXNsaW50LWltcG9ydC1yZXNvbHZlci0ke25hbWV9YClcbiAgfSBjYXRjaCAoZXJyKSB7IC8qIGNvbnRpbnVlICovIH1cblxuICAvLyBhbGwgZWxzZSBmYWlsZWRcbiAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gbG9hZCByZXNvbHZlciBcIiR7bmFtZX1cIi5gKVxufVxuXG5jb25zdCBlcnJvcmVkQ29udGV4dHMgPSBuZXcgU2V0KClcblxuLyoqXG4gKiBHaXZlblxuICogQHBhcmFtICB7c3RyaW5nfSBwIC0gbW9kdWxlIHBhdGhcbiAqIEBwYXJhbSAge29iamVjdH0gY29udGV4dCAtIEVTTGludCBjb250ZXh0XG4gKiBAcmV0dXJuIHtzdHJpbmd9IC0gdGhlIGZ1bGwgbW9kdWxlIGZpbGVzeXN0ZW0gcGF0aDtcbiAqICAgICAgICAgICAgICAgICAgICBudWxsIGlmIHBhY2thZ2UgaXMgY29yZTtcbiAqICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQgaWYgbm90IGZvdW5kXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHJlc29sdmUocCwgY29udGV4dCkge1xuICB0cnkge1xuICAgIHJldHVybiByZWxhdGl2ZSggcFxuICAgICAgICAgICAgICAgICAgICwgY29udGV4dC5nZXRGaWxlbmFtZSgpXG4gICAgICAgICAgICAgICAgICAgLCBjb250ZXh0LnNldHRpbmdzXG4gICAgICAgICAgICAgICAgICAgKVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIWVycm9yZWRDb250ZXh0cy5oYXMoY29udGV4dCkpIHtcbiAgICAgIGNvbnRleHQucmVwb3J0KHtcbiAgICAgICAgbWVzc2FnZTogYFJlc29sdmUgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCxcbiAgICAgICAgbG9jOiB7IGxpbmU6IDEsIGNvbDogMCB9LFxuICAgICAgfSlcbiAgICAgIGVycm9yZWRDb250ZXh0cy5hZGQoY29udGV4dClcbiAgICB9XG4gIH1cbn1cbnJlc29sdmUucmVsYXRpdmUgPSByZWxhdGl2ZVxuXG5cbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nXG5mdW5jdGlvbiBoYXNoT2JqZWN0KG9iamVjdCkge1xuICBjb25zdCBzZXR0aW5nc1NoYXN1bSA9IGNyZWF0ZUhhc2goJ3NoYTEnKVxuICBzZXR0aW5nc1NoYXN1bS51cGRhdGUoSlNPTi5zdHJpbmdpZnkob2JqZWN0KSlcbiAgcmV0dXJuIHNldHRpbmdzU2hhc3VtLmRpZ2VzdCgnaGV4Jylcbn1cbiJdfQ==